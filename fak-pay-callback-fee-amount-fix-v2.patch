diff --git a/db/init.sql b/db/init.sql
index 38021ec..f2e45ce 100755
--- a/db/init.sql
+++ b/db/init.sql
@@ -27,6 +27,7 @@ CREATE TABLE IF NOT EXISTS payment_settings (
   gateway_url TEXT NOT NULL DEFAULT '',
   merchant_id TEXT NOT NULL DEFAULT '',
   merchant_key TEXT NOT NULL DEFAULT '',
+  callback_base_url TEXT NOT NULL DEFAULT '',
   fee_percent NUMERIC(5,2) NOT NULL DEFAULT 0 CHECK (fee_percent >= 0 AND fee_percent <= 100),
   created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
   updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
@@ -56,11 +57,6 @@ VALUES (
   '#f6f7fb',
   NULL
 )
-  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
-);
-
-INSERT INTO site_settings (id, site_title, footer_left, footer_right, announcement)
-VALUES (1, '发卡站', '© 2026 发卡站', '订单链接包含访问凭证，请妥善保存，勿外泄。', '')
 ON CONFLICT (id) DO NOTHING;
 
 INSERT INTO payment_settings (
@@ -68,9 +64,10 @@ INSERT INTO payment_settings (
   gateway_url,
   merchant_id,
   merchant_key,
+  callback_base_url,
   fee_percent
 )
-VALUES (1, '', '', '', 0)
+VALUES (1, '', '', '', '', 0)
 ON CONFLICT (id) DO NOTHING;
 
 CREATE TABLE IF NOT EXISTS products (
@@ -92,6 +89,7 @@ CREATE TABLE IF NOT EXISTS orders (
   customer_note TEXT,
   status TEXT NOT NULL, -- pending/paid/delivered/expired/canceled/delivery_failed
   total_cents BIGINT NOT NULL CHECK (total_cents >= 0),
+  payable_cents BIGINT NOT NULL DEFAULT 0 CHECK (payable_cents >= 0),
   reserved_expires_at TIMESTAMPTZ,
   paid_at TIMESTAMPTZ,
   delivered_at TIMESTAMPTZ,
diff --git a/src/db.js b/src/db.js
index f9bcb4c..6b0acdf 100755
--- a/src/db.js
+++ b/src/db.js
@@ -68,6 +68,20 @@ async function ensureSchema() {
     ON CONFLICT (id) DO NOTHING
     `
   );
+
+  // ---- Orders extensions (backward compatible) ----
+  try {
+    const { rows } = await pool.query("SELECT to_regclass('public.orders') AS t");
+    if (rows && rows[0] && rows[0].t) {
+      await pool.query(`ALTER TABLE orders ADD COLUMN IF NOT EXISTS payable_cents BIGINT`);
+      await pool.query(`UPDATE orders SET payable_cents = total_cents WHERE payable_cents IS NULL`);
+      await pool.query(`ALTER TABLE orders ALTER COLUMN payable_cents SET DEFAULT 0`);
+      await pool.query(`ALTER TABLE orders ALTER COLUMN payable_cents SET NOT NULL`);
+    }
+  } catch (e) {
+    // 不阻塞服务启动；但若这里报错，支付金额校验可能不可用
+    console.log(`[db] ensure orders extensions failed: ${e.message}`);
+  }
 }
 
 async function withClient(fn) {
diff --git a/src/routes/admin.js b/src/routes/admin.js
index 9d3ab0e..1b60db0 100755
--- a/src/routes/admin.js
+++ b/src/routes/admin.js
@@ -254,10 +254,11 @@ router.post('/payment-settings', requireAdmin, async (req, res) => {
   const gatewayUrl = String(req.body.gateway_url || '').trim();
   const merchantId = String(req.body.merchant_id || '').trim();
   const merchantKey = String(req.body.merchant_key || '').trim();
+  const callbackBaseUrl = String(req.body.callback_base_url || '').trim();
   const feePercent = String(req.body.fee_percent || '').trim();
 
   try {
-    await updatePaymentSettings({ gatewayUrl, merchantId, merchantKey, feePercent });
+    await updatePaymentSettings({ gatewayUrl, merchantId, merchantKey, callbackBaseUrl, feePercent });
     req.session.flash = { type: 'success', message: '支付配置已更新' };
   } catch (e) {
     req.session.flash = { type: 'danger', message: e.message || '支付配置更新失败' };
diff --git a/src/routes/public.js b/src/routes/public.js
index 435cd30..afb1105 100755
--- a/src/routes/public.js
+++ b/src/routes/public.js
@@ -18,6 +18,8 @@ const {
   formatMoney,
   lookupOrdersPublic,
   getOrderAccessToken,
+  setOrderPayableCents,
+  getOrderPayableCents,
 } = require('../services/orderService');
 
 const { config } = require('../config');
@@ -31,10 +33,29 @@ function escapeHtml(value) {
     .replace(/'/g, '&#39;');
 }
 
-function getBaseUrl(req) {
+function getBaseUrl(req, paymentSettings) {
+  const configured = paymentSettings ? String(paymentSettings.callback_base_url || '').trim() : '';
+  if (configured) return configured.replace(/\/$/, '');
   return `${req.protocol}://${req.get('host')}`;
 }
 
+function calcPayableCents(totalCents, feePercent) {
+  const total = Number(totalCents || 0);
+  const fee = Number(feePercent || 0);
+  if (!Number.isFinite(total) || total < 0) return 0;
+  if (!Number.isFinite(fee) || fee <= 0) return total;
+  const feeCents = Math.ceil((total * fee) / 100);
+  return total + feeCents;
+}
+
+function parseMoneyToCents(money) {
+  const s = String(money || '').trim();
+  if (!/^\d+(\.\d{1,2})?$/.test(s)) return null;
+  const [i, d = ''] = s.split('.');
+  const cents = Number(i) * 100 + Number(d.padEnd(2, '0').slice(0, 2));
+  return Number.isFinite(cents) ? cents : null;
+}
+
 function isPaymentReady(settings) {
   return Boolean(settings.gateway_url && settings.merchant_id && settings.merchant_key);
 }
@@ -175,6 +196,8 @@ router.get('/pay/:orderNo/:token', async (req, res) => {
     getSiteSettings(),
     getPaymentSettings(),
   ]);
+  const feePercent = Number(paymentSettings.fee_percent || 0);
+  const payableCents = calcPayableCents(data.order.total_cents, feePercent);
   const { methods: paymentMethods } = await fetchYipayPaymentMethods(paymentSettings);
   res.render('public/pay', {
     title: '支付',
@@ -184,6 +207,8 @@ router.get('/pay/:orderNo/:token', async (req, res) => {
     siteSettings,
     paymentMethods,
     paymentReady: isPaymentReady(paymentSettings),
+    feePercent,
+    payableCents,
   });
 });
 
@@ -218,7 +243,18 @@ router.post('/pay/:orderNo/:token', async (req, res) => {
     return res.redirect(`/pay/${encodeURIComponent(orderNo)}/${encodeURIComponent(token)}`);
   }
 
-  const baseUrl = getBaseUrl(req);
+  const feePercent = Number(paymentSettings.fee_percent || 0);
+  const payableCents = calcPayableCents(data.order.total_cents, feePercent);
+
+  // 将本次支付应付金额写入订单（用于后续回调金额校验，避免后台修改手续费后导致历史订单不一致）
+  try {
+    await setOrderPayableCents(orderNo, payableCents);
+  } catch (e) {
+    // 不影响下单，但会降低金额校验的准确性
+    console.log(`[pay] setOrderPayableCents failed for ${orderNo}: ${e.message}`);
+  }
+
+  const baseUrl = getBaseUrl(req, paymentSettings);
   const { submitUrl } = getGatewayEndpoints(paymentSettings.gateway_url);
   const payload = {
     pid: paymentSettings.merchant_id,
@@ -227,7 +263,7 @@ router.post('/pay/:orderNo/:token', async (req, res) => {
     notify_url: `${baseUrl}/pay/notify`,
     return_url: `${baseUrl}/pay/return`,
     name: `订单 ${orderNo}`,
-    money: formatMoney(data.order.total_cents),
+    money: formatMoney(payableCents),
   };
   // submit.php 下单签名同样遵循“参数字典序拼接 + KEY”规则
   const sign = buildYipaySign(payload, paymentSettings.merchant_key);
@@ -276,6 +312,23 @@ router.post('/pay/notify', async (req, res) => {
     return res.send('success');
   }
 
+  // -------- 金额校验（含手续费后的应付金额） --------
+  const paidCents = parseMoneyToCents(payload.money);
+  if (paidCents === null) {
+    console.log(`[notify] invalid money: ${payload.money} (order ${payload.out_trade_no})`);
+    return res.status(400).send('fail');
+  }
+  const expected = await getOrderPayableCents(payload.out_trade_no);
+  if (!expected) {
+    console.log(`[notify] order not found: ${payload.out_trade_no}`);
+    return res.send('success');
+  }
+  if (paidCents !== Number(expected.payableCents)) {
+    console.log(`[notify] money mismatch order=${payload.out_trade_no} expected=${expected.payableCents} got=${paidCents}`);
+    // 返回 success 以避免平台反复重试，但不触发发货
+    return res.send('success');
+  }
+
   try {
     await markPaidAndDeliver(payload.out_trade_no, { force: true });
     return res.send('success');
@@ -299,6 +352,22 @@ router.get('/pay/return', async (req, res) => {
 
   const tradeStatus = String(payload.trade_status || '').toUpperCase();
   if (tradeStatus === 'TRADE_SUCCESS' || tradeStatus === 'SUCCESS') {
+    // -------- 金额校验（含手续费后的应付金额） --------
+    const paidCents = parseMoneyToCents(payload.money);
+    if (paidCents === null) {
+      req.session.flash = { type: 'danger', message: '金额格式异常，已拦截支付回调，请联系商家' };
+      return res.redirect('/query');
+    }
+    const expected = await getOrderPayableCents(payload.out_trade_no);
+    if (!expected) {
+      req.session.flash = { type: 'danger', message: '订单不存在，无法处理回调' };
+      return res.redirect('/query');
+    }
+    if (paidCents !== Number(expected.payableCents)) {
+      req.session.flash = { type: 'danger', message: '金额校验失败（应付金额不一致），请联系商家' };
+      return res.redirect('/query');
+    }
+
     try {
       await markPaidAndDeliver(payload.out_trade_no, { force: true });
       req.session.flash = { type: 'success', message: '支付成功，订单已处理' };
diff --git a/src/services/orderService.js b/src/services/orderService.js
index 7861676..51ff3aa 100755
--- a/src/services/orderService.js
+++ b/src/services/orderService.js
@@ -61,12 +61,12 @@ for (let i = 0; i < 5; i += 1) {
     const orderRes = await client.query(
       `
       INSERT INTO orders
-        (order_no, access_token, customer_contact, customer_note, status, total_cents, reserved_expires_at, created_at, updated_at)
+        (order_no, access_token, customer_contact, customer_note, status, total_cents, payable_cents, reserved_expires_at, created_at, updated_at)
       VALUES
-        ($1, $2, $3, $4, 'pending', $5, $6, NOW(), NOW())
-      RETURNING id, order_no, access_token, status, total_cents, reserved_expires_at, created_at
+        ($1, $2, $3, $4, 'pending', $5, $6, $7, NOW(), NOW())
+      RETURNING id, order_no, access_token, status, total_cents, payable_cents, reserved_expires_at, created_at
       `,
-      [orderNo, accessToken, customerContact, customerNote, totalCents, reservedExpiresAt]
+      [orderNo, accessToken, customerContact, customerNote, totalCents, totalCents, reservedExpiresAt]
     );
     const order = orderRes.rows[0];
 
@@ -487,6 +487,29 @@ async function releaseExpiredReservations() {
   );
 }
 
+// 支付应付金额（含手续费）写入订单，用于回调金额校验
+async function setOrderPayableCents(orderNo, payableCents) {
+  if (!orderNo) throw new Error('orderNo required');
+  const v = Number(payableCents);
+  if (!Number.isFinite(v) || v < 0) throw new Error('invalid payableCents');
+  await pool.query(
+    `UPDATE orders SET payable_cents=$2, updated_at=NOW() WHERE order_no=$1`,
+    [orderNo, v]
+  );
+}
+
+async function getOrderPayableCents(orderNo) {
+  if (!orderNo) return null;
+  const { rows } = await pool.query(
+    `SELECT total_cents, payable_cents FROM orders WHERE order_no=$1 LIMIT 1`,
+    [orderNo]
+  );
+  if (!rows[0]) return null;
+  const totalCents = Number(rows[0].total_cents || 0);
+  const payableCents = Number(rows[0].payable_cents ?? rows[0].total_cents ?? 0);
+  return { totalCents, payableCents };
+}
+
 function formatMoney(cents) {
   const v = Number(cents || 0) / 100;
   return v.toFixed(2);
@@ -500,6 +523,8 @@ module.exports = {
   markPaidAndDeliver,
   cancelOrder,
   releaseExpiredReservations,
+  setOrderPayableCents,
+  getOrderPayableCents,
   formatMoney,
   lookupOrdersPublic,
   getOrderAccessToken,
diff --git a/src/services/paymentSettingsService.js b/src/services/paymentSettingsService.js
index f83191f..ff44d25 100644
--- a/src/services/paymentSettingsService.js
+++ b/src/services/paymentSettingsService.js
@@ -4,6 +4,9 @@ const defaultSettings = {
   gateway_url: '',
   merchant_id: '',
   merchant_key: '',
+  // 可选：用于生成 notify_url / return_url 的回调域名（例如 https://example.com）
+  // 留空时会根据请求的 Host 自动推断（反代未正确传 Host 时可能变成 127.0.0.1）
+  callback_base_url: '',
   fee_percent: 0,
 };
 
@@ -15,12 +18,18 @@ async function ensureTable() {
       gateway_url TEXT NOT NULL DEFAULT '',
       merchant_id TEXT NOT NULL DEFAULT '',
       merchant_key TEXT NOT NULL DEFAULT '',
+      callback_base_url TEXT NOT NULL DEFAULT '',
       fee_percent NUMERIC(5,2) NOT NULL DEFAULT 0 CHECK (fee_percent >= 0 AND fee_percent <= 100),
       created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
       updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
     )
     `
   );
+
+  // 兼容旧版本：补列
+  await pool.query(
+    `ALTER TABLE payment_settings ADD COLUMN IF NOT EXISTS callback_base_url TEXT NOT NULL DEFAULT ''`
+  );
 }
 
 async function ensureRow() {
@@ -32,15 +41,17 @@ async function ensureRow() {
       gateway_url,
       merchant_id,
       merchant_key,
+      callback_base_url,
       fee_percent
     )
-    VALUES (1, $1, $2, $3, $4)
+    VALUES (1, $1, $2, $3, $4, $5)
     ON CONFLICT (id) DO NOTHING
     `,
     [
       defaultSettings.gateway_url,
       defaultSettings.merchant_id,
       defaultSettings.merchant_key,
+      defaultSettings.callback_base_url,
       defaultSettings.fee_percent,
     ]
   );
@@ -60,11 +71,22 @@ function validateGatewayUrl(gatewayUrl) {
   }
 }
 
+function normalizeBaseUrl(baseUrl) {
+  const v = String(baseUrl || '').trim();
+  if (!v) return '';
+  const parsed = new URL(v);
+  if (!['http:', 'https:'].includes(parsed.protocol)) {
+    throw new Error('回调域名必须是 http(s):// 开头');
+  }
+  // 去掉结尾的 /，避免拼接出双斜杠
+  return parsed.toString().replace(/\/$/, '');
+}
+
 async function getPaymentSettings() {
   await ensureRow();
   const { rows } = await pool.query(
     `
-    SELECT gateway_url, merchant_id, merchant_key, fee_percent
+    SELECT gateway_url, merchant_id, merchant_key, callback_base_url, fee_percent::float8 AS fee_percent
     FROM payment_settings
     WHERE id = 1
     `
@@ -77,11 +99,13 @@ async function updatePaymentSettings({
   gatewayUrl,
   merchantId,
   merchantKey,
+  callbackBaseUrl,
   feePercent,
 }) {
   const trimmedGatewayUrl = String(gatewayUrl || '').trim();
   const trimmedMerchantId = String(merchantId || '').trim();
   const trimmedMerchantKey = String(merchantKey || '').trim();
+  const normalizedCallbackBaseUrl = normalizeBaseUrl(callbackBaseUrl);
   const feeValue = Number(feePercent);
 
   if (!trimmedGatewayUrl) {
@@ -106,18 +130,20 @@ async function updatePaymentSettings({
       gateway_url,
       merchant_id,
       merchant_key,
+      callback_base_url,
       fee_percent,
       updated_at
     )
-    VALUES (1, $1, $2, $3, $4, NOW())
+    VALUES (1, $1, $2, $3, $4, $5, NOW())
     ON CONFLICT (id) DO UPDATE SET
       gateway_url = EXCLUDED.gateway_url,
       merchant_id = EXCLUDED.merchant_id,
       merchant_key = EXCLUDED.merchant_key,
+      callback_base_url = EXCLUDED.callback_base_url,
       fee_percent = EXCLUDED.fee_percent,
       updated_at = NOW()
     `,
-    [trimmedGatewayUrl, trimmedMerchantId, trimmedMerchantKey, feeValue]
+    [trimmedGatewayUrl, trimmedMerchantId, trimmedMerchantKey, normalizedCallbackBaseUrl, feeValue]
   );
 
   return getPaymentSettings();
diff --git a/src/views/admin/payment_settings.ejs b/src/views/admin/payment_settings.ejs
index b052566..52e14f9 100644
--- a/src/views/admin/payment_settings.ejs
+++ b/src/views/admin/payment_settings.ejs
@@ -18,6 +18,14 @@
         <div class="muted">支持易支付的 submit.php 与 mapi.php 接口地址。</div>
       </div>
 
+      <div class="field">
+        <label class="label">回调域名（可选）</label>
+        <input class="input" name="callback_base_url" value="<%= settings.callback_base_url %>" placeholder="https://techforgo.eu">
+        <div class="muted">
+          用于生成 notify_url / return_url。留空则按请求 Host 自动推断；若你使用 Nginx 反代但未正确转发 Host，可能会变成 127.0.0.1。
+        </div>
+      </div>
+
       <div class="field">
         <label class="label">商户ID</label>
         <input class="input" name="merchant_id" value="<%= settings.merchant_id %>" placeholder="填写商户ID">
diff --git a/src/views/public/pay.ejs b/src/views/public/pay.ejs
index 08f2800..12a336f 100755
--- a/src/views/public/pay.ejs
+++ b/src/views/public/pay.ejs
@@ -1,15 +1,20 @@
-<%- include('../partials/public_header', { title, admin, flash }) %>
-<% const o = data.order; %>
-
+<%- include('../partials/public_header', { title, admin, flash }) %>
+<% const o = data.order; %>
+
 <section class="card">
   <div class="card-top">
     <div class="card-title">支付</div>
   </div>
-
-  <div class="desc" style="margin-top:10px;">
-    订单号：<strong><%= o.order_no %></strong> · 金额：<strong>￥<%= formatMoney(o.total_cents) %></strong>
-  </div>
-
+
+  <div class="desc" style="margin-top:10px;">
+    订单号：<strong><%= o.order_no %></strong>
+    · 订单金额：<strong>￥<%= formatMoney(o.total_cents) %></strong>
+    <% if (feePercent && Number(feePercent) > 0) { %>
+      · 手续费：<strong><%= feePercent %>%</strong>
+      · 应付金额：<strong>￥<%= formatMoney(payableCents) %></strong>
+    <% } %>
+  </div>
+
   <% if (!paymentReady) { %>
     <div class="alert alert-warning" style="margin-top:14px;">
       支付通道暂未配置，请联系商家处理或稍后再试。
@@ -34,5 +39,5 @@
     <a class="btn" href="/order/<%= encodeURIComponent(o.order_no) %>/<%= encodeURIComponent(o.access_token) %>">返回订单</a>
   </div>
 </section>
-
-<%- include('../partials/public_footer') %>
+
+<%- include('../partials/public_footer') %>
